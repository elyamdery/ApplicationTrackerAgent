<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Applications Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .nav-links {
            display: flex;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Job Applications Tracker</h1>
            <div class="nav-links">
                <a href="/guide" class="nav-link">User Guide</a>
                <a href="/settings" class="nav-link">Settings</a>
            </div>
        </header>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div id="connection-dot" class="connection-dot {{ 'connected' if is_authenticated else 'disconnected' }}" title="Connection Status"></div>
                <div class="status-info">
                    <div id="status-message" class="status-text">
                        {{ 'Connected to Gmail: ' + monitored_email if is_authenticated else 'Not connected to Gmail' }}
                    </div>
                    <div class="status-details">
                        <span id="agent-status">{{ 'All agents active' if is_authenticated else 'Agents inactive' }}</span>
                        ‚Ä¢
                        <span id="last-scan">Last scan: {{ last_scan_time or 'Never' }}</span>
                    </div>
                </div>
            </div>
            <div class="status-actions">
                <!-- Add scan status display -->
                <div id="scan-status-container">
                    <span id="scan-status" class="status-text"></span>
                </div>
                <button id="scan-now-btn" class="status-btn scan-btn" {{ 'disabled' if not is_authenticated }}>
                    <span id="scan-spinner" class="spinner" style="display: none;"></span>
                    <span id="scan-text">Scan Now</span>
                </button>
                <a href="/settings" class="status-btn settings-btn">Settings</a>
            </div>
        </div>

        <section class="application-form-section">
            <h2 class="section-title">Add New Application</h2>
            <form id="application-form">
                <div class="form-group">
                    <label for="company">Company Name:</label>
                    <input type="text" id="company" name="company" required>
                </div>
                <div class="form-group">
                    <label for="role">Role/Position:</label>
                    <input type="text" id="role" name="role" required>
                </div>
                <div class="form-group">
                    <label for="date_applied">Date Applied:</label>
                    <input type="date" id="date_applied" name="date_applied" required>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status" required>
                        <option value="applied">Applied</option>
                        <option value="interview">Interview</option>
                        <option value="offer">Offer</option>
                        <option value="rejected">Rejected</option>
                        <option value="withdrawn">Withdrawn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn primary-btn">Add Application</button>
                    <button type="reset" class="btn secondary-btn">Clear</button>
                </div>
            </form>
        </section>

        <section class="applications-section">
            <div class="section-header">
                <h2 class="section-title">Your Applications</h2>
                <div class="section-actions">
                    <button id="export-csv-btn" class="btn secondary-btn">Export to CSV</button>
                    <div class="filter-container">
                        <label for="status-filter">Filter by Status:</label>
                        <select id="status-filter">
                            <option value="all">All</option>
                            <option value="applied">Applied</option>
                            <option value="interview">Interview</option>
                            <option value="offer">Offer</option>
                            <option value="rejected">Rejected</option>
                            <option value="withdrawn">Withdrawn</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="applications-container">
                <table id="applications-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Role</th>
                            <th>Date Applied</th>
                            <th>Status</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in applications %}
                        <tr data-id="{{ app['id'] }}" data-status="{{ app['status'] }}">
                            <td>{{ app['company'] }}</td>
                            <td>{{ app['role'] }}</td>
                            <td>{{ app['date_applied'] }}</td>
                            <td>
                                <span class="status-badge {{ app['status'] }}">
                                    {{ app['status'].capitalize() }}
                                </span>
                            </td>
                            <td>{{ app['notes'] }}</td>
                            <td class="actions-cell">
                                <button class="action-btn edit-btn" title="Edit">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" title="Delete">üóëÔ∏è</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                {% if not applications %}
                <div class="empty-state">
                    <p>No applications found. Add your first application or scan your email.</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- Edit Application Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Application</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id" name="id">
                <div class="form-group">
                    <label for="edit-company">Company Name:</label>
                    <input type="text" id="edit-company" name="company" required>
                </div>
                <div class="form-group">
                    <label for="edit-role">Role/Position:</label>
                    <input type="text" id="edit-role" name="role" required>
                </div>
                <div class="form-group">
                    <label for="edit-date">Date Applied:</label>
                    <input type="date" id="edit-date" name="date_applied" required>
                </div>
                <div class="form-group">
                    <label for="edit-status">Status:</label>
                    <select id="edit-status" name="status" required>
                        <option value="applied">Applied</option>
                        <option value="interview">Interview</option>
                        <option value="offer">Offer</option>
                        <option value="rejected">Rejected</option>
                        <option value="withdrawn">Withdrawn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-notes">Notes:</label>
                    <textarea id="edit-notes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn primary-btn">Save Changes</button>
                    <button type="button" class="btn secondary-btn" id="cancel-edit">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Confirm Deletion</h2>
            <p>Are you sure you want to delete this application?</p>
            <div class="form-actions">
                <button id="confirm-delete" class="btn danger-btn">Delete</button>
                <button id="cancel-delete" class="btn secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Application form submission
            const applicationForm = document.getElementById('application-form');
            applicationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(applicationForm);
                const application = {
                    company: formData.get('company'),
                    role: formData.get('role'),
                    date_applied: formData.get('date_applied'),
                    status: formData.get('status'),
                    notes: formData.get('notes')
                };
                
                fetch('/api/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(application)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page to show the new application
                        window.location.reload();
                    } else {
                        alert('Error adding application: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding the application.');
                });
            });
            
            // Status filter
            const statusFilter = document.getElementById('status-filter');
            statusFilter.addEventListener('change', function() {
                const status = this.value;
                const rows = document.querySelectorAll('#applications-table tbody tr');
                
                rows.forEach(row => {
                    if (status === 'all' || row.dataset.status === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
            
            // Export to CSV
            const exportBtn = document.getElementById('export-csv-btn');
            exportBtn.addEventListener('click', function() {
                window.location.href = '/export_csv';
            });
            
            // Edit application
            const editBtns = document.querySelectorAll('.edit-btn');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEdit = document.getElementById('cancel-edit');
            const closeEditBtn = editModal.querySelector('.close-btn');
            
            editBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const id = row.dataset.id;
                    
                    // Fetch application details
                    fetch(`/api/applications/${id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const app = data.application;
                                document.getElementById('edit-id').value = app.id;
                                document.getElementById('edit-company').value = app.company;
                                document.getElementById('edit-role').value = app.role;
                                document.getElementById('edit-date').value = app.date_applied;
                                document.getElementById('edit-status').value = app.status;
                                document.getElementById('edit-notes').value = app.notes;
                                
                                editModal.style.display = 'block';
                            } else {
                                alert('Error fetching application details: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while fetching application details.');
                        });
                });
            });
            
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(editForm);
                const id = formData.get('id');
                const application = {
                    company: formData.get('company'),
                    role: formData.get('role'),
                    date_applied: formData.get('date_applied'),
                    status: formData.get('status'),
                    notes: formData.get('notes')
                };
                
                fetch(`/api/applications/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(application)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page to show the updated application
                        window.location.reload();
                    } else {
                        alert('Error updating application: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the application.');
                });
            });
            
            cancelEdit.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
            
            closeEditBtn.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
            
            // Delete application
            const deleteBtns = document.querySelectorAll('.delete-btn');
            const deleteModal = document.getElementById('delete-modal');
            const confirmDelete = document.getElementById('confirm-delete');
            const cancelDelete = document.getElementById('cancel-delete');
            const closeDeleteBtn = deleteModal.querySelector('.close-btn');
            let deleteId = null;
            
            deleteBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    deleteId = row.dataset.id;
                    deleteModal.style.display = 'block';
                });
            });
            
            confirmDelete.addEventListener('click', function() {
                if (deleteId) {
                    fetch(`/api/applications/${deleteId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Refresh the page to show the updated list
                            window.location.reload();
                        } else {
                            alert('Error deleting application: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the application.');
                    });
                }
            });
            
            cancelDelete.addEventListener('click', function() {
                deleteModal.style.display = 'none';
                deleteId = null;
            });
            
            closeDeleteBtn.addEventListener('click', function() {
                deleteModal.style.display = 'none';
                deleteId = null;
            });
            
            // Scan Now button
            const scanBtn = document.getElementById('scan-now-btn');
            const scanSpinner = document.getElementById('scan-spinner');
            const scanText = document.getElementById('scan-text');
            const scanStatus = document.getElementById('scan-status');
            
            scanBtn.addEventListener('click', function() {
                if (scanBtn.disabled) return;
                
                // Show spinner and update text
                scanSpinner.style.display = 'inline-block';
                scanText.textContent = 'Scanning...';
                scanBtn.disabled = true;
                scanStatus.textContent = 'Scanning emails...';
                
                fetch('/scan_now')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            scanStatus.textContent = data.message;
                            
                            // Poll for scan completion
                            const pollInterval = setInterval(() => {
                                fetch('/scan_status')
                                    .then(response => response.json())
                                    .then(statusData => {
                                        if (statusData.status === 'completed') {
                                            clearInterval(pollInterval);
                                            scanSpinner.style.display = 'none';
                                            scanText.textContent = 'Scan Now';
                                            scanBtn.disabled = false;
                                            
                                            const result = statusData.result;
                                            if (result) {
                                                scanStatus.textContent = `Scan completed: ${result.processed} emails processed, ${result.new} new applications, ${result.updated} updated.`;
                                                
                                                // Refresh the page after a short delay
                                                setTimeout(() => {
                                                    window.location.reload();
                                                }, 3000);
                                            } else {
                                                scanStatus.textContent = 'Scan completed.';
                                            }
                                        } else if (statusData.status === 'error') {
                                            clearInterval(pollInterval);
                                            scanSpinner.style.display = 'none';
                                            scanText.textContent = 'Scan Now';
                                            scanBtn.disabled = false;
                                            scanStatus.textContent = `Error: ${statusData.error}`;
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error polling scan status:', error);
                                    });
                            }, 2000);
                        } else {
                            scanSpinner.style.display = 'none';
                            scanText.textContent = 'Scan Now';
                            scanBtn.disabled = false;
                            scanStatus.textContent = `Error: ${data.error}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error starting scan:', error);
                        scanSpinner.style.display = 'none';
                        scanText.textContent = 'Scan Now';
                        scanBtn.disabled = false;
                        scanStatus.textContent = 'Error starting scan.';
                    });
            });
        });
    </script>
</body>
</html>
